<?php
#
# Copyright (c) 2000-2016 University of Utah and the Flux Group.
# 
# {{{EMULAB-LICENSE
# 
# This file is part of the Emulab network testbed software.
# 
# This file is free software: you can redistribute it and/or modify it
# under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or (at
# your option) any later version.
# 
# This file is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public
# License for more details.
# 
# You should have received a copy of the GNU Affero General Public License
# along with this file.  If not, see <http://www.gnu.org/licenses/>.
# 
# }}}
#
chdir("..");
chdir("apt");
include_once("profile_defs.php");
include_once("instance_defs.php");
include_once("ajax-routines.ajax");

# We set this in CheckPageArgs
$target_project = null;

#
# Need to check the permission, since we allow admins to mess with
# other accounts.
#
function CheckPageArgs()
{
    global $this_user;
    global $ajax_args;

    if (!ISADMIN()) {
	SPITAJAX_ERROR(-1, "Not enough permission");
	return -1;
    }
    return 0;
}

function Do_SearchUsers()
{
    global $this_user;
    global $ajax_args;
    global $PORTAL_GENESIS, $ISEMULAB;
    $results = array();

    if (CheckPageArgs()) {
        return;
    }
    if (!isset($ajax_args["text"])) {
	SPITAJAX_ERROR(-1, "Missing text to search for");
	return -1;
    }
    $text = $ajax_args["text"];
    if (!preg_match("/^[\.\@\w]*$/", $text)) {
	SPITAJAX_ERROR(-1, "Illegal text to search for");
	return -1;
    }
    $portal_test = "portal='$PORTAL_GENESIS'";
    if ($ISEMULAB) {
        $portal_test = "(portal is null or $portal_test)";
    }
    $query_result =
        DBQueryFatal("select uid,usr_name,usr_affil,portal from users ".
                     "where $portal_test and ".
                     "      (uid like '%${text}%' or ".
                     "       usr_affil like '%${text}%' or ".
                     "       LCASE(usr_email) like '%${text}%' or ".
                     "       usr_name like '%${text}%') ".
                     "order by uid");

    while ($row = mysql_fetch_array($query_result)) {
        $blob = array();
        
        $blob["usr_uid"]    = $row["uid"];
        $blob["usr_name"]   = $row["usr_name"];
        $blob["usr_affil"]  = $row["usr_affil"];
        $results[] = $blob;
    }
    SPITAJAX_RESPONSE($results);
}

function Do_SearchProjects()
{
    global $this_user;
    global $ajax_args;
    global $PORTAL_GENESIS, $ISEMULAB;
    $results = array();

    if (CheckPageArgs()) {
        return;
    }
    if (!isset($ajax_args["text"])) {
	SPITAJAX_ERROR(-1, "Missing text to search for");
	return -1;
    }
    $text = $ajax_args["text"];
    if (!preg_match("/^\w*$/", $text)) {
	SPITAJAX_ERROR(-1, "Illegal text to search for");
	return -1;
    }
    $portal_test = "p.portal='$PORTAL_GENESIS'";
    if ($ISEMULAB) {
        $portal_test = "(p.portal is null or $portal_test)";
    }
    $query_result =
        DBQueryFatal("select pid,u.uid,u.usr_name,u.usr_affil,p.portal ".
                     "  from projects as p ".
                     "left join users as u on u.uid_idx=p.head_idx ".
                     "where $portal_test and ".
                     "      (pid like '%${text}%' or ".
                     "       p.name like '%${text}%' or ".
                     "       p.why like '%${text}%' or ".
                     "       u.usr_name like '%${text}%' or ".
                     "       u.usr_affil like '%${text}%') ".
                     "order by pid");

    while ($row = mysql_fetch_array($query_result)) {
        $blob = array();

        $blob["pid"]        = $row["pid"];
        $blob["usr_uid"]    = $row["uid"];
        $blob["usr_name"]   = $row["usr_name"];
        $blob["usr_affil"]  = $row["usr_affil"];
        $results[] = $blob;
    }
    SPITAJAX_RESPONSE($results);
}

# Local Variables:
# mode:php
# End:
?>
