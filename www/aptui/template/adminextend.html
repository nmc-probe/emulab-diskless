<style>
.scrollable-panel {
	max-height:350px;
	overflow-y:scroll;
}
td textarea {
	width: 100%;
	height: 100%;
}
.history-tstamp {
	min-width: 100px;
	width:100px;
	max-width: 100px;
}
pre {
	white-space: pre-wrap;
}
.table th, .table td { 
        border-top: none !important;
        border-left: none !important;
}
.panel-body {
	padding: 3px;
}
.table {
	margin: 2px;
}
.table-condensed > thead > tr > th,
.table-condensed > tbody > tr > th,
.table-condensed > tfoot > tr > th,
.table-condensed > thead > tr > td,
.table-condensed > tbody > tr > td,
.table-condensed > tfoot > tr > td {
	padding: 3px;
}
.panel-heading {
	padding: 5px;
}
</style>
<div class="row" id="firstrow"></div>
<div class="row" id="secondrow"></div>
<div class="row hidden" id="extension-reason-row">
  <div class='col-sm-8 col-sm-offset-2' style="margin-bottom: 10px;"><pre></pre></div>
</div>
<div class='row'>
  <div class='col-sm-8 col-sm-offset-2' style="margin-bottom: 10px;">
    <center>
      Message to send to user
      <br>
      <textarea id='reason'
		class='form-control'
		rows=5></textarea>
      <div style="margin-top: 10px;">
	<button class='btn btn-danger btn-sm'
		style='margin-right: 20px;'
		id='deny-extension'
		type='submit' name='request'>Deny</button>
	<input id="days" value="0" type="text" size="4" placeholder="days">
	<button class='btn btn-primary btn-sm'
		style='margin-left: 20px;'
		id='do-extension'
		type='submit' name='request'>Extend</button>
      </div>
    </center>
  </div>
</div>
<div class="row" id="thirdrow"></div>
<div class='row'>
  <div class='col-sm-10 col-sm-offset-1
	      col-xs-12 col-xs-offset-0'>
    <div class='panel panel-default hidden' id="utilization-panel-div">
      <div class="panel-heading">
	<h5>
	  <a data-toggle="collapse" id="utilization-toggle"
	     href="#utilization-collapse"><span>Utilization</span>
	    <span class="glyphicon glyphicon-chevron-right pull-right"></span>
	  </a>
	</h5>
      </div>
      <div id="utilization-collapse"
	   class="panel-collapse collapse">
	<div class='panel-body'>
	  <div class="scrollable-panel"
	       id="utilization-panel-content"
	       data-status="minimized"></div>
	</div>
      </div>
    </div>
  </div>
  <div id='waitwait_div'></div>
  <div id='oops_div'></div>
</div>
<div class='row'>
  <div class='col-sm-10 col-sm-offset-1
	      col-xs-12 col-xs-offset-0'>
    <div class='panel panel-default hidden' id="history-panel-div">
      <div class="panel-heading">
	<h5>
	  <a data-toggle="collapse" id="history-toggle"
	     href="#history-collapse"><span>Extension History</span>
	    <span class="glyphicon glyphicon-chevron-right pull-right"></span>
	  </a>
	</h5>
      </div>
      <div id="history-collapse"
	   class="panel-collapse collapse">
	<div class='panel-body'>
	  <div class="scrollable-panel"
	       id="history-panel-content"
	       data-status="minimized"></div>
	</div>
      </div>
    </div>
  </div>
  <div id='waitwait_div'></div>
  <div id='oops_div'></div>
</div>
<div>
  <script id="history-template" type="text/template">
    <table class="table table-condensed">
      <thead>
	<tr>
	  <th>Date</th>
	  <th>Action</th>
	  <th>Wanted</th>
	  <th>Granted</th>
	</tr>
      </thead>
      <tbody>
	<%  _.each(extensions, function(extension, idx) { %>
	  <tr>
	    <td rowspan="2" class="history-tstamp"><%- extension.tstamp %></td>
	    <td>
	      <% if (extension.action == "request" && extension.admin == "1") { %>
		admin<% } else { %><%- extension.action %><% } %>
	    </td>
	    <% if (extension.action == "request") { %>
	      <td><%- extension.wanted %></td>
	      <td><%- extension.granted %></td>
	    <% } else { %>
	      <td>n/a</td>
	      <td>n/a</td>
	    <% } %>
	  </tr>
	  <tr>
	    <td colspan="3"><pre class="history-reason"><%= extension.reason %></pre>
	    </td>
	  </tr>
	<% }); %>
      </tbody>
    </table>
  </script>
</div>
<div>
  <script id="firstrow-template" type="text/template">
    <div class='col-sm-8 col-sm-offset-2'>
      <div class='panel panel-default'>
	<div class="panel-heading text-center">
	  Experiment info for <%= expinfo.name %>
	</div>
	<div class="panel-body">
	  <table class="table table-condensed">
	    <tbody>
	      <tr>
		<td>Name:</td>
		<td><a href='status.php?uuid=<%- uuid %>'><%- expinfo.name %></a></td>
		<td>Profile:</td>
		<% if (expinfo.profile_uuid) { %>
		  <td><a href='show-profile.php?uuid=<%- expinfo.profile_uuid %>'>
		    <%- expinfo.profile_name %></a></td>
		<% } else { %>
		  <td><%- expinfo.profile_name %></td>
   	        <% } %>
	      </tr>
	      <tr>
		<td>Creator:</td>
		<td><a href='user-dashboard.php?user=<%- expinfo.creator %>'>
		  <%- expinfo.creator %></a></td>
		<td>Project:</td>
		<td><a href='show-project.php?project=<%- expinfo.project %>'>
		  <%- expinfo.project %></a></td>
	      </tr>
	      <tr>
		<td>Created:</td>
		<td class="format-date"><%- expinfo.created %></td>
		<td>Expires:</td>
		<td class="format-date"><%- expinfo.expires %></td>
	      </tr>
	      <tr>
		<td>Lockout:</td>
		<td><% if (expinfo.lockout) { %>
		  <span class="text-danger">Yes</span><% } else { %>No<% } %></td>
		<td>Lockdown:</td>
		<td><% if (expinfo.lockdown) { %>
		  <span class="text-danger">Yes</span><% } else { %>No<% } %></td>
	    </tbody>
	  </table>
	</div>
      </div>
    </div>
  </script>
</div>
<div>
  <script id="secondrow-template" type="text/template">
    <div class='col-sm-6'>
      <div class='panel panel-default'>
	<div class="panel-heading text-center">
	  Summary for user <%= uid %>
	</div>
	<div class="panel-body">
	  <table class="table table-condensed">
	    <tbody>
	      <tr>
		<td>Current Usage:</td>
		<td><%- user.pnodes %> Node(s), <%- user.phours %> Node Hours</td>
	      </tr>
	      <tr>
		<td>Prev Week:</td>
		<td><%- user.weekpnodes %> Node(s), <%- user.weekphours %> Node Hours</td>
	      </tr>
	      <tr>
		<td>Prev Month:</td>
		<td><%- user.monthpnodes %> Node(s), <%- user.monthphours %> Node Hours</td>
	      </tr>
	      <% if (user.rank) { %>
		<tr>
		  <td><%- user.rankdays %> Day Ranking:</td>
		  <td>#<%- user.rank %> of <%- user.ranktotal %> active users</td>
		</tr>
	      <% } %>
	      <tr>
		<td># of Experiments:</td>
		<td><%- user.expcount %></td>
	      </tr>
	    </tbody>
	  </table>
	</div>
      </div>
    </div>
    <div class='col-sm-6'>
      <div class='panel panel-default'>
	<div class="panel-heading text-center">
	  Summary for project <%= pid %>
	</div>
	<div class="panel-body">
	  <table class="table table-condensed">
	    <tbody>
	      <tr>
		<td>Current Usage:</td>
		<td><%- project.pnodes %> Node(s), <%- project.phours %> Node Hours</td>
	      </tr>
	      <tr>
		<td>Prev Week:</td>
		<td><%- project.weekpnodes %> Node(s),
		  <%- project.weekphours %> Node Hours</td>
	      </tr>
	      <tr>
		<td>Prev Month:</td>
		<td><%- project.monthpnodes %> Node(s),
		  <%- project.monthphours %> Node Hours</td>
	      </tr>
	      <% if (project.rank) { %>
		<tr>
		  <td><%- project.rankdays %> Day Ranking:</td>
		  <td>#<%- project.rank %> of
		    <%- project.ranktotal %> active projects</td>
		</tr>
	      <% } %>
	      <tr>
		<td># of Experiments:</td>
		<td><%- project.expcount %></td>
	      </tr>
	    </tbody>
	  </table>
	</div>
      </div>
    </div>
  </script>
</div>
<div>
  <script id="utilization-template" type="text/template">
    <div class='col-sm-12'>
      <table class="tablesorter" id="utilization-table">
	<thead>
	  <th>Node</th>
	  <th>Type</th>
	  <th>Cluster</th>
	  <th>Status</th>
	  <th>State</th>
	  <th>Idle</th>
	  <th>Load (1/5/15)</th>
	</thead>
	<tbody>
	  <%  _.each(utilization, function(site, name) { %>
	    <%  _.each(site.details.nodes, function(node, nodeid) { %>
	      <tr>
		<td><%- nodeid %> (<%- node.client_id %>)</td>
		<td><%- node.nodetype %></td>
		<td><%- name %></td>
		<td>
		  <% if (_.has(node, 'status')) { %><%- node.status.status %>
		  <% } else { %>n/a<% } %>
		</td>
		<td><%- node.eventstate %></td>
		<td>
		  <% if (_.has(node, 'idledata')) { %>
		    <%- (node.idledata.idletime / 3600).toFixed(2) %>
		  <% } else { %>n/a<% } %>
		</td>
		<td>
		  <% if (_.has(node, 'rusage')) { %>
		    <%- node.rusage.load["60"] %>/<%- node.rusage.load["300"] %>/<%- node.rusage.load["900"] %>
		  <% } else { %>n/a<% } %>
		</td>
	      </tr>
	    <% }); %>
	  <% }); %>
	</tbody>
      </table>
    </div>
  </script>
</div>
<div>
  <script id="summary-template" type="text/template">
    <div class='col-sm-6 col-sm-offset-3'>
      <div class='panel panel-default'>
	<div class="panel-heading text-center">
	  Node usage summary
	</div>
	<div class="panel-body">
	  <table class="table table-condensed">
	    <thead>
	      <tr>
		<th>Type</th>
		<th>Cluster</th>
		<th>Used</th>
		<th>Free</th>
		<th>Total</th>
	      </tr>
	    </thead>
	    <tbody>
	      <%  _.each(utilization, function(site, name) { %>
		<%  _.each(site.typeinfo, function(info, type) { %>
		  <tr>
		    <td><%- type %></td>
		    <td><%- name %></td>
		    <td><%- info.count %></td>
		    <td><%- info.free %></td>
		    <td><%- info.total %></td>
		  </tr>
		<% }); %>
	      <% }); %>
	    </tbody>
	  </table>
	</div>
      </div>
    </div>
  </script>
</div>
